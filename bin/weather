#!/usr/bin/env zsh
# We need the floating point math of zsh
#/ Usage: weather [FLAG]
#/
#/ Powered by https://www.weatherapi.com/
#/
#/ Cache:   ${CACHE}
#/ Api Key: ${API_KEY_PATH}
#/
#/ Flags:
#/  -h|--help     Show this help
#/  -r|--refresh  Force a refresh
#/     --waybar   Show JSON for waybar
#/  -w|--wait     Wait for a keypress before exiting

set -e

SRC="${0}"
show_help() {
	export CACHE API_KEY_PATH
	grep ^#/ <"${SRC}" | cut -c4- | envsubst
}

CACHE="$HOME/.local/state/waybar/weather_cache.json"
API_KEY_PATH="$HOME/.local/state/waybar/weather_cache.key"

WAIT=0
REFRESH=0
WAYBAR=0

weather_to_emoji() {
	case $1 in
		"clear")   echo "â˜€ï¸" ;;
		"cloud")   echo "â˜ï¸" ;;
		"mist")    echo "  " ;; # can't find a good mist emoji
		"rain")    echo "ðŸŒ§ï¸" ;;
		"snow")    echo "â„ï¸" ;;
		"drizzle") echo "ðŸŒ¦ï¸" ;;
		"thunder") echo "â›ˆï¸" ;;
		*) echo "" ;;
	esac
}

# From:
# curl https://www.weatherapi.com/docs/weather_conditions.json | gojq '.[] | "\(.code) \(.day)"'
condition_to_weather(){
	case "${1}" in
		"1000") echo "clear" ;;
		"1003" | "1006" | "1009") echo "cloud" ;;
		"1030" | "1135" | "1147") echo "mist" ;;
		"1066" | "1069" | "1072" | "1114" | "1117" | "1168" | "1171" | "1198" | "1201" | "1204" | "1207" | "1210" | "1213" | "1216" | "1219" | "1222" | "1225" | "1237" | "1249" | "1252" | "1255" | "1258" | "1261" | "1264") echo "snow" ;;
		"1087" | "1273" | "1276" | "1279" | "1282") echo "thunder" ;;
		"1063" | "1150" | "1153" | "1180" | "1183") echo "drizzle" ;;
		"1186" | "1189" | "1192" | "1195" | "1240" | "1243" | "1246") echo "rain" ;;
		*) echo "unknown: ${1}" ;;
	esac
}

# TODO: refactor
condition_to_emoji() {
	weather_to_emoji $(condition_to_weather "${1}")
}


while [ "${#}" -gt 0 ]; do
	case "${1}" in
		-h|--help) show_help && exit 0 ;;
		-w|--wait) WAIT=1 ;;
		--waybar) WAYBAR=1 ;;
		-r|--refresh) REFRESH=1 ;;
		-*)
			echo "Unknown flag '${1}'"
			show_help
			exit 1
			;;

		# Break on non-flags
		*)  break ;;
	esac
	shift 1
done

if [ ! -f "${CACHE}" ] || ! find "${CACHE}" -mmin 60 || [[ "${REFRESH}" == 1 ]]; then
	API_KEY="$(cat "${API_KEY_PATH}")"
	LOCATION="BERLIN"

	curl --silent \
		-o "${CACHE}" \
		"http://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${LOCATION}&days=3&aqi=no&alerts=no"

fi

if [[ "${WAYBAR}" == 1 ]]; then
	gojq -r '.current | "\(.feelslike_c) \(.condition.code) \(.last_updated)"' "${CACHE}" \
		| while read -r feels code updated; do
		emoji=$(condition_to_emoji "${code}")
		echo "{\"text\": \"${feels}Â°C ${emoji}\", \"tooltip\": \"${updated}\"}"
	done
	exit 0
fi

# Full from here down

gojq -r '.current | "\(.feelslike_c) \(.condition.code) \(.last_updated)"' "${CACHE}" \
	| while read -r feels code updated; do
	emoji=$(condition_to_emoji "${code}")
	echo "Current: ${feels}Â°C ${emoji}"
done
printf "\n\n"

# Dates
printf "    "
gojq -j '
.forecast.forecastday[].hour[].time | split(" ") | .[1] as $t |
	if $t == "23:00" then
		"       |"
	elif $t == "06:00" then
		"      \(.[0])"
	else
		""
	end
	' "${CACHE}"
	printf "\n"

# Temperature graph
min=$(gojq '[.forecast.forecastday[].hour[].feelslike_c] | min | floor' "${CACHE}")
max=$(gojq '[.forecast.forecastday[].hour[].feelslike_c] | max | ceil' "${CACHE}")
div=$(gojq '[.forecast.forecastday[].hour[].feelslike_c] | ((max | ceil) - (min | floor))/10.0' "${CACHE}")

for i in $(seq 0 10); do
	# Floating point here requires zsh
	high=$((max - div * i))
	low=$((high - div))

	# Floating point comparison here requires zsh
	if [ "${i}" -eq 0 ]; then
		printf "%4d " "${max}"
	elif [ "${i}" -eq 5 ]; then
		printf "%4d " "${low}"
	elif [ "${i}" -eq 10 ]; then
		printf "%4d " "${min}"
	else
		printf "     "
	fi

	# shellcheck disable=SC2016 # $f is the gojq variable
	gojq -j '
	.forecast.forecastday[].hour[].feelslike_c as $f |
		if ('"${low}"' <= $f and $f <= '"${high}"') then
			if $f <= -5 then
				"\u001b[36mâ–ˆ\u001b[m"
			elif $f <= 0 then
				"\u001b[34mâ–ˆ\u001b[m"
			elif $f <= 5 then
				"\u001b[32mâ–ˆ\u001b[m"
			elif $f <= 10 then
				"\u001b[33mâ–ˆ\u001b[m"
			else
				"\u001b[31mâ–ˆ\u001b[m"
			end
		elif ('"${i}"' == 5) then
			"-"
		else
			" "
		end
		' "${CACHE}"
		printf "\n"
	done

# Print weather emojis
printf "     "
cat "${CACHE}" \
	| gojq -r '.forecast.forecastday[].hour[].condition.code' \
	| while read -r code; read -r discard; do
		emoji=$(condition_to_emoji "${code}")
		printf "${emoji}"
done
printf "\n"


printf "     "
gojq -j '
.forecast.forecastday[].hour[].time | split(" ") | .[1] as $t |
	if $t == "00:00" then
		"|"
	elif $t == "12:00" then
		"+"
	else
		"-"
	end
' "${CACHE}"
printf "\n"

printf "     "
gojq -j '
.forecast.forecastday[].hour[].time | split(" ") | .[1] as $t |
	if $t == "00:00" then
		"0     "
	elif $t == "06:00" then
		"6     "
	elif $t == "12:00" then
		"12    "
	elif $t == "18:00" then
		"18    "
	else
		""
	end
' "${CACHE}"
printf "\n"

# Print precipitation graph
for i in $(seq 0 0.1 1); do
	printf "     "

	# shellcheck disable=SC2016 # $f is the gojq variable
	gojq -j '
	.forecast.forecastday[].hour[].precip_mm as $f |
		if ('"${i}"' < $f) then
			"\u001b[34mâ–ˆ\u001b[m"
		else
			" "
		end
		' "${CACHE}"
	printf "\n"
done

	echo "Refreshed at $(gojq -j '.current.last_updated' "${CACHE}")"

if [[ "${WAIT}" == 1 ]]; then
	read -k 1 '?press any key to continue'
fi
