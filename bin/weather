#!/usr/bin/env zsh
# We need the floating point math of zsh
#/ Usage: weather [FLAG]
#/
#/ Powered by https://www.weatherapi.com/
#/
#/ Cache:   ${CACHE}
#/ Api Key: ${API_KEY_PATH}
#/
#/ Flags:
#/  -h|--help     Show this help
#/  -r|--refresh  Force a refresh
#/     --waybar   Show JSON for waybar
#/     --simple   Show only simple
#/  -w|--wait     Wait for a keypress before exiting

set -e

SRC="${0}"
show_help() {
	export CACHE API_KEY_PATH
	grep ^#/ <"${SRC}" | cut -c4- | envsubst
}

CACHE="$HOME/.local/state/waybar/weather_cache.json"
API_KEY_PATH="$HOME/.local/state/waybar/weather_cache.key"

WAIT=0
REFRESH=0
WAYBAR=0
SIMPLE=0

# From:
# curl https://www.weatherapi.com/docs/weather_conditions.json | jq '.[] | "\(.code) \(.day)"'
condition_to_emoji(){
	code=${1}
	is_day=${2:-1}

	case "${1}" in
		"1000") [[ "${is_day}" -eq "1" ]] && echo "â˜€ï¸" || echo "ðŸŒ™";;
		"1003" | "1006" | "1009") echo "â›…" ;; # cloud
		"1030" | "1135" | "1147") echo "â˜ï¸" ;; # mist
		"1066" | "1069" | "1072" | "1114" | "1117" | "1168" | "1171" | "1198" | "1201" | "1204" | "1207" | "1210" | "1213" | "1216" | "1219" | "1222" | "1225" | "1237" | "1249" | "1252" | "1255" | "1258" | "1261" | "1264") echo "â„ï¸" ;; # snow
		"1087" | "1273" | "1276" | "1279" | "1282") echo "â›ˆï¸" ;; # thunder
		"1063" | "1150" | "1153" | "1180" | "1183") echo "ðŸŒ¦ï¸" ;; # drizzle
		"1186" | "1189" | "1192" | "1195" | "1240" | "1243" | "1246") echo "ðŸŒ§ï¸" ;; # rain
		*) echo "unknown: ${1}" ;;
	esac
}

while [ "${#}" -gt 0 ]; do
	case "${1}" in
		-h|--help) show_help && exit 0 ;;
		-w|--wait) WAIT=1 ;;
		--waybar) WAYBAR=1 ;;
		--simple) SIMPLE=1 ;;
		-r|--refresh) REFRESH=1 ;;
		-*)
			echo "Unknown flag '${1}'"
			show_help
			exit 1
			;;

		# Break on non-flags
		*)  break ;;
	esac
	shift 1
done

if [ ! -f "${CACHE}" ] || [ -n "$(find "${CACHE}" -mmin +60 -print -quit)" ] || [[ "${REFRESH}" == 1 ]]; then
	API_KEY="$(cat "${API_KEY_PATH}")"
	LOCATION="BERLIN"

	curl --silent \
		-o "${CACHE}" \
		"http://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${LOCATION}&days=3&aqi=no&alerts=no"
fi

feels=$(jq -r '.current.feelslike_c' "${CACHE}")
code=$(jq -r '.current.condition.code' "${CACHE}")
is_day=$(jq -r '.current.condition.is_day' "${CACHE}")
emoji=$(condition_to_emoji "${code}" "${is_day}")
last_updated=$(jq -r '.current.last_updated' "${CACHE}")

if [[ "${WAYBAR}" == 1 ]]; then
	echo "{\"text\": \"${feels}Â°C ${emoji}\", \"tooltip\": \"${last_updated}\"}"
	exit 0
fi

if [[ "${SIMPLE}" == 1 ]]; then
	echo "${feels}Â°C ${emoji}"
	exit 0
fi

# Full from here down

echo "Current: ${feels}Â°C ${emoji}"
printf "\n\n"

# Dates
printf "            $(date +"%Y-%m-%d")       |      $(date +%Y-%m-%d -d '+1 day')       |      $(date +%Y-%m-%d -d '+2 day')      \n"

# Temperature graph
min=$(jq '[.forecast.forecastday[].hour[].feelslike_c] | min | floor' "${CACHE}")
max=$(jq '[.forecast.forecastday[].hour[].feelslike_c] | max | ceil' "${CACHE}")
div=$(jq '[.forecast.forecastday[].hour[].feelslike_c] | ((max | ceil) - (min | floor))/10.0' "${CACHE}")

for i in $(seq 0 10); do
	# Floating point here requires zsh
	high=$((max - div * i))
	low=$((high - div))

	# Floating point comparison here requires zsh
	if [ "${i}" -eq 0 ]; then
		printf "%4d " "${max}"
	elif [ "${i}" -eq 5 ]; then
		printf "%4d " "${low}"
	elif [ "${i}" -eq 10 ]; then
		printf "%4d " "${min}"
	else
		printf "     "
	fi

	# shellcheck disable=SC2016 # $f is the jq variable
	jq -j '
	.forecast.forecastday[].hour[].feelslike_c as $f |
		if ('"${low}"' <= $f and $f <= '"${high}"') then
			if $f <= -5 then
				"\u001b[36mâ–ˆ\u001b[m"
			elif $f <= 0 then
				"\u001b[34mâ–ˆ\u001b[m"
			elif $f <= 5 then
				"\u001b[32mâ–ˆ\u001b[m"
			elif $f <= 10 then
				"\u001b[33mâ–ˆ\u001b[m"
			else
				"\u001b[31mâ–ˆ\u001b[m"
			end
		elif ('"${i}"' == 5) then
			"-"
		else
			" "
		end
		' "${CACHE}"
		printf "\n"
	done

# Print weather emojis
printf "     "
cat "${CACHE}" \
	| jq -r '.forecast.forecastday[].hour[] | "\(.condition.code) \(.is_day)"' \
	| while read -r code is_day; read -r discard discard; do
		emoji=$(condition_to_emoji "${code}" "${is_day}")
		printf "${emoji}"
done
printf "\n"

# Print timeline with custom marker for right now.
current_h=$(date +%H)
printf "     "
jq -j '
.forecast.forecastday[0].hour[].time | split(" ")[1] | split(":")[0] as $t |
	if $t == "'"${current_h}"'" then
		"\u001b[31mâ–ˆ\u001b[m"
	elif $t == "00" then
		"|"
	elif $t == "12" then
		"+"
	else
		"-"
	end
' "${CACHE}"

printf "|-----------+-----------|-----------+-----------\n"
printf "     0     6     12    18    0     6     12    18    0     6     12    18    \n"

# Print precipitation graph
for i in $(seq 0 0.1 1); do
	printf "     "

	# shellcheck disable=SC2016 # $f is the jq variable
	jq -j '
	.forecast.forecastday[].hour[].precip_mm as $f |
		if ('"${i}"' < $f) then
			"\u001b[34mâ–ˆ\u001b[m"
		else
			" "
		end
		' "${CACHE}"
	printf "\n"
done

echo "Refreshed at ${last_updated}"

if [[ "${WAIT}" == 1 ]]; then
	read -k 1 '?press any key to continue'
fi
