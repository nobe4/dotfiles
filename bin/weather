#!/usr/bin/env bash
#/ Usage: weather [FLAG]
#/
#/ Cache: ${CACHE}
#/
#/ Flags:
#/  -h|--help     Show this help
#/  -f|--full     Show in full
#/  -r|--refresh  Force a refresh
#/     --waybar   Show JSON for waybar
#/  -w|--wait     Wait for a keypress before exiting

set -e

show_help() {
	export CACHE
	grep ^#/ <"${0}" |cut -c4- | envsubst
}
CACHE="$HOME/.local/state/waybar/weather_cache"

FULL=0
WAIT=0
REFRESH=0
WAYBAR=0

while [ "${#}" -gt 0 ]; do
	case "${1}" in
		-h|--help) show_help && exit 0 ;;
		-f|--full) FULL=1 ;;
		-w|--wait) WAIT=1 ;;
		--waybar) WAYBAR=1 ;;
		-r|--refresh) REFRESH=1 ;;
		-*)
			echo "Unknown flag '${1}'"
			show_help
			exit 1
			;;

		# Break on non-flags
		*)  break ;;
	esac
	shift 1
done

if [ ! -f "${CACHE}" ] || ! find "${CACHE}" -mmin 60 || [[ "${REFRESH}" == 1 ]]; then
	short=$(curl -s wttr.in/berlin?format=%f%20%c)
	full=$(
		curl -s wttr.in/berlin?format=v2d \
	)

	if [ -n "${short}" ] && [ -n "${full}" ]; then
		mkdir -p "$(dirname "${CACHE}")"
		touch "${CACHE}"

		echo "${short}" > "${CACHE}"
		echo "${full}" >> "${CACHE}"
	fi
fi

if [[ "${WAYBAR}" == 1 ]]; then
	echo "{\"text\": \"$(head -n 1 "${CACHE}")\", \"tooltip\": \"$(date -r "${CACHE}" +"%y-%m-%d %H:%M")\"}"
	exit 0
fi

if [[ "${FULL}" == 1 ]]; then
	tail -n +2 "${CACHE}" | head -n -2
else
	head -n 1 "${CACHE}"
fi

if [[ "${WAIT}" == 1 ]]; then
	read -r -n 1 -p "press any key to continue" < /dev/tty
fi
