#!/usr/bin/env bash

set -e

parts="$(
  # shellcheck disable=2001
  # cannot really use the variable replacement easily
  echo "${1}" \
    | sed 's;^https://github.com/\([^/]*\)/\([^/]*\)/[^/]*/\([0-9]*\)\(#issuecomment-\([0-9]*\)\)*.*;\1 \2 \3 \5;'
)"

owner="$(echo "${parts}" | cut -d' ' -f1)"
repo="$(echo "${parts}" | cut -d' ' -f2)"
issue="$(echo "${parts}" | cut -d' ' -f3)"
comment="$(echo "${parts}" | cut -d' ' -f4)"

endpoint="/repos/${owner}/${repo}/issues/${issue}"
if [ "${comment}" != "" ]; then
  endpoint="/repos/${owner}/${repo}/issues/comments/${comment}"
fi

file="$(mktemp -d)/comment.md"

gh api "${endpoint}" -q '.body' > "${file}"

(
  last_update="$(ls -l "${file}")"
  while true; do
    sleep 1
    new_update="$(ls -l "$file")"
    if [ "${new_update}" != "${last_update}" ]; then
      gh api --method PATCH "${endpoint}" -f body="$(cat "${file}")"
      last_update="${new_update}"
    fi
  done
) 1>/dev/null 2>&1 &
watch_pid="${!}"

${EDITOR} "${file}"

# Wait for the save+quit to upload
sleep 1

kill "${watch_pid}"
wait "${watch_pid}" 2>/dev/null
