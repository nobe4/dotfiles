#!/usr/bin/env bash
#/ Usage: wait_for_pr [URL]
set -e

show_help() {
	grep ^#/ <"${0}" |cut -c4- | envsubst
}

while [ "${#}" -gt 0 ]; do
	case "${1}" in
		# Some flags exit directly
		-h|--help) show_help && exit 0 ;;
		-c|--clear) CLEAR=1 ;;
		-r|--ring) RING=1 ;;
		*)  break ;;
	esac
	shift 1
done

set -e

while true; do
	[ "${CLEAR}" == "1" ] && clear

	gh pr checks "${1}" && checks_passed=0 || checks_passed=1

	missing_approvals_count="$(gh pr view "${1}" --json reviewRequests -q '.reviewRequests | length')"
	if [ "${missing_approvals_count}" == "0" ]; then
		echo "âœ“  All required approvals done"
	else
		echo "*  ${missing_approvals_count} remaining approvals needed"
	fi

	if [ "${checks_passed}" == "0" ] && [ "${missing_approvals_count}" == "0" ]; then
		break
	fi

	sleep 1
	echo -e "\n---\n"
done

[ "${RING}" == "1" ] && ( ring "pr ${1} is ready" ) &
